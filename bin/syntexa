#!/usr/bin/env bash
set -euo pipefail

CMD="${1:-help}"
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PORT="${SWOOLE_PORT:-9501}"

ensure_swoole() {
  if ! php -r 'exit((int)!extension_loaded("swoole"));'; then
    echo "âŒ Swoole extension not found"
    echo "Syntexa runs only under Swoole."
    echo "Install Swoole: https://www.swoole.co.uk/docs/get-started/installation"
    exit 1
  fi
}

start() {
  echo "ðŸš€ Starting Syntexa Framework..."
  ensure_swoole
  echo "âœ… Swoole extension found"
  echo "ðŸ”„ Starting in Swoole mode..."
  echo "ðŸŒ Server will be available at: http://localhost:${PORT}"
  # Prevent duplicate masters: stop if pid file exists and alive
  PID_FILE="${ROOT_DIR}/var/swoole.pid"
  if [ -f "${PID_FILE}" ]; then
    PID=$(cat "${PID_FILE}" || true)
    if [ -n "${PID}" ] && ps -p "$PID" >/dev/null 2>&1; then
      echo "âš ï¸  Existing server detected (pid ${PID}). Stopping it first."
      kill -TERM "$PID" 2>/dev/null || true
      sleep 1
    fi
    rm -f "${PID_FILE}" 2>/dev/null || true
  fi
  SWOOLE_PORT="${PORT}" php "${ROOT_DIR}/server.php"
}

stop() {
  echo "ðŸ›‘ Stopping Syntexa on port ${PORT}..."
  PID_FILE="${ROOT_DIR}/var/swoole.pid"
  if [ -f "${PID_FILE}" ]; then
    PID=$(cat "${PID_FILE}" || true)
    if [ -n "${PID}" ] && ps -p "$PID" >/dev/null 2>&1; then
      echo "Master PID: ${PID}"
      kill -TERM "$PID" 2>/dev/null || true
      sleep 1
      if ps -p "$PID" >/dev/null 2>&1; then
        kill -9 "$PID" 2>/dev/null || true
      fi
    fi
    rm -f "${PID_FILE}" 2>/dev/null || true
    echo "Stopped."
    return 0
  fi
  # Fallback to port-based stop
  PIDS=$(ss -ltnp 2>/dev/null | awk -v port=":${PORT}" '$4 ~ port {print $6}' | sed -n 's/.*pid=\([0-9]*\).*/\1/p' | sort -u)
  if [ -z "${PIDS}" ]; then
    echo "No processes found on port ${PORT}."
    return 0
  fi
  echo "PIDs: ${PIDS}"
  for pid in ${PIDS}; do kill -TERM "$pid" 2>/dev/null || true; done
  sleep 1
  REMAIN=$(ss -ltnp 2>/dev/null | awk -v port=":${PORT}" '$4 ~ port {print $6}' | sed -n 's/.*pid=\([0-9]*\).*/\1/p' | sort -u)
  if [ -n "${REMAIN}" ]; then
    for pid in ${REMAIN}; do kill -9 "$pid" 2>/dev/null || true; done
  fi
  echo "Stopped."
}

restart() {
  stop
  start
}

watch() {
  echo "ðŸ‘€ Watch mode on port ${PORT}"
  if command -v entr >/dev/null 2>&1; then
    find "${ROOT_DIR}" -type f \( -name "*.php" -o -name "composer.json" \) | \
      entr -r bash -c "SWOOLE_PORT=${PORT} \"${BASH_SOURCE[0]}\" restart"
    exit 0
  fi
  if command -v inotifywait >/dev/null 2>&1; then
    while inotifywait -e modify,create,delete,move -r "${ROOT_DIR}" --exclude 'vendor/|\.git/'; do
      SWOOLE_PORT="${PORT}" "${BASH_SOURCE[0]}" restart
    done
    exit 0
  fi
  echo "Neither 'entr' nor 'inotifywait' found. Install one of them."
  exit 1
}

help() {
  cat <<EOF
Syntexa CLI

Usage:
  $(basename "$0") <command> [options]

Commands:
  start           Start Swoole HTTP server (uses SWOOLE_PORT, default 9501)
  stop            Stop all PHP processes listening on SWOOLE_PORT (default 9501)
  restart         Stop then start server on SWOOLE_PORT
  watch           Watch filesystem changes and auto-restart (requires entr or inotifywait)
  request:generate [Request]   Build/refresh request wrapper(s)
  response:generate [Response] Build/refresh response wrapper(s)
  layout:generate [Layout]     Copy module layouts into src/
  queue:work [transport] [queue]  Run async handler worker
  help            Show this help

Examples:
  SWOOLE_PORT=9510 $(basename "$0") start
  $(basename "$0") stop
  $(basename "$0") watch
EOF
}

case "${CMD}" in
  start) start ;;
  stop) stop ;;
  restart) restart ;;
  watch) watch ;;
  request:generate)
    shift
    php "${ROOT_DIR}/tools/request-generator.php" "$@"
    ;;
  response:generate)
    shift
    php "${ROOT_DIR}/tools/response-generator.php" "$@"
    ;;
  layout:generate)
    shift
    php "${ROOT_DIR}/tools/layout-generator.php" "$@"
    ;;
  queue:work)
    shift
    php "${ROOT_DIR}/tools/queue-worker.php" "$@"
    ;;
  help|-h|--help) help ;;
  *) help ; exit 2 ;;
esac
